# راهنمای کامل رفع مشکل کنترل دما در پروژه‌های HVAC

## تشخیص و رفع مشکل ارتباط با دستگاه‌های HVAC

### ۱. مشکل اصلی:
دستگاه‌های HVAC معمولاً فقط فرمت خاصی از درخواست‌ها را می‌پذیرند. مشکل زمانی پیش می‌آید که:
- داشبورد: `?name=TempSetpoint&value=25` می‌فرستد
- دستگاه: فقط `?CurrRoomTempSetP_Val=25` می‌شناسد

### ۲. فایل‌های کلیدی برای بررسی:

#### ۲.۱. فایل پیکربندی (`dashboard.config.json`):
```json
{
  "deviceUrl": "http://169.254.61.68/getvar.csv",
  "units": [
    {
      "vars": {
        "TempSetpoint": "CurrRoomTempSetP_Val"  // مپینگ متغیرها
      },
      "setpoint": { "min": 10, "max": 30, "step": 0.5 }
    }
  ]
}
```

#### ۲.۲. فایل منطق ارسال (`varsAdapter.ts`):
```typescript
// در تابع write، آرایه patterns را به این صورت تغییر دهید:
const patterns = [
  // فرمت جدید: مستقیماً متغیر دستگاه را set می‌کند
  '?' + encodeURIComponent(name) + '=' + encodeURIComponent(value),
  
  // فرمت‌های قدیمی (به عنوان fallback)
  '?name=' + encodeURIComponent(name) + '&value=' + encodeURIComponent(value),
  '?name=' + encodeURIComponent(name) + '&val=' + encodeURIComponent(value),
  '?id=' + encodeURIComponent(name) + '&value=' + encodeURIComponent(value),
  '?var=' + encodeURIComponent(name) + '&val=' + encodeURIComponent(value)
]
```

### ۳. مراحل پیاده‌سازی برای پروژه جدید:

#### مرحله ۱: بررسی پیکربندی
- فایل `config.json` یا `dashboard.config.json` را پیدا کنید
- mapping بین متغیرهای داشبورد و دستگاه را بررسی کنید

#### مرحله ۲: اصلاح منطق ارسال
- فایل مربوط به ارسال درخواست‌ها (معمولاً `varsAdapter.ts` یا similar) را پیدا کنید
- فرمت مستقیم را به اولویت اول آرایه patterns اضافه کنید

#### مرحله ۳: تست ارتباط

##### دستورات تست در PowerShell:
```powershell
# تست ارتباط پایه با دستگاه
ping 169.254.61.68

# تست درخواست مستقیم به دستگاه (اگر curl نصب است)
curl "http://169.254.61.68/getvar.csv?CurrRoomTempSetP_Val=25"

# جایگزین curl در PowerShell:
Invoke-WebRequest -Uri "http://169.254.61.68/getvar.csv?CurrRoomTempSetP_Val=25"

# تست از طریق پروکسی (اگر پروژه از پروکسی استفاده می‌کند)
Invoke-WebRequest -Uri "http://localhost:3000/api/proxy?url=http://169.254.61.68/getvar.csv?CurrRoomTempSetP_Val=25"
```

##### دستورات تست در Command Prompt:
```cmd
ping 169.254.61.68

# اگر curl نصب است:
curl "http://169.254.61.68/getvar.csv?CurrRoomTempSetP_Val=25"

# یا از PowerShell استفاده کنید
```

### ۴. عیب‌یابی رایج:

#### ۴.۱. خطای ۵۰۲/۵۰۳ در پروکسی:
```powershell
# تنظیم متغیر محیطی برای whitelist کردن hostها
$env:ALLOWED_PROXY_HOSTS="169.254.61.68,localhost"

# سپس سرور را اجرا کنید
npm run dev
```

#### ۴.۲. مشکلات ساخت:
```powershell
# ابتدا build کنید
npm run build

# سپس اجرا کنید  
npm start
```

#### ۴.۳. بررسی اینکه سرور در پورت صحیح اجرا شده:
```powershell
# بررسی processes در پورت 3000
netstat -ano | findstr :3000

# یا kill process اگر نیاز است
taskkill /pid [PID] /f
```

### ۵. ساختار پیشنهادی برای پروژه‌های جدید:

#### ۵.۱. فایل پیکربندی:
```json
{
  "deviceUrl": "http://[DEVICE_IP]/getvar.csv",
  "pollingInterval": 5000,
  "units": [
    {
      "id": "unit1",
      "vars": {
        "TempSetpoint": "CurrRoomTempSetP_Val",
        "CurrentTemp": "CurrRoomTemp_Val",
        "Mode": "OperationMode_Val"
      },
      "setpoint": { "min": 10, "max": 30, "step": 0.5 }
    }
  ],
  "allowedHosts": ["169.254.61.68", "localhost"]
}
```

#### ۵.۲. نمونه کد ارسال درخواست:
```typescript
async function sendToDevice(variableName: string, value: any) {
  const patterns = [
    `?${encodeURIComponent(variableName)}=${encodeURIComponent(value)}`,
    `?name=${encodeURIComponent(variableName)}&value=${encodeURIComponent(value)}`,
    `?var=${encodeURIComponent(variableName)}&val=${encodeURIComponent(value)}`
  ];
  
  for (const pattern of patterns) {
    try {
      const response = await fetch(`${config.deviceUrl}${pattern}`);
      if (response.ok) return true;
    } catch (error) {
      console.warn(`Pattern ${pattern} failed, trying next...`);
    }
  }
  return false;
}
```

### ۶. نکات مهم:

۱. **همیشه ابتدا ارتباط پایه را تست کنید** (ping)
۲. **فرمت مستقیم را اولویت اول قرار دهید**
۳. **متغیرهای محیطی را برای پروکسی تنظیم کنید**
۴. **از error handling مناسب استفاده کنید**
۵. **لاگ‌های console را مانیتور کنید**

### ۷. دستورات مفید برای مدیریت پروژه:

```powershell
# نصب dependencies
npm install

# اجرای development mode
npm run dev

# ساخت production build  
npm run build

# اجرای production
npm start

# تست
npm test
```

---

## ایجاد شده در: 2025-11-22
## برای پروژه‌های: Next.js Dashboard با دستگاه‌های HVAC
## نویسنده: Assistant

این راهنما برای تمام پروژه‌هایی که با دستگاه‌های صنعتی ارتباط دارند قابل استفاده است.

**نمای کلی**

- پروژه شامل دو بخش است:
  - بک‌اند ساده با `Express` که فایل‌های وب را سرو می‌کند، مسیرهای احراز هویت و مدیریت لیست چیلرها دارد، و یک مسیر پروکسی برای ارتباط امن با دستگاه.
  - فرانت‌اند صفحه داشبورد که متغیرهای دستگاه را می‌خواند و می‌نویسد، وضعیت اتصال را نشان می‌دهد، و کنترل‌هایی مثل روشن/خاموش و ست‌پوینت فراهم می‌کند.

**نحوه اجرا**

- پوشه پروژه اصلی: `c:\Users\HesaM\Desktop\dashboard`
- اجرای سرور:
  - دستور: `npm start`
  - پورت: `8000`
  - مسیرها:
    - ورود: `http://localhost:8000/login`
    - داشبورد: `http://localhost:8000/dashboard`
    - ادمین: `http://localhost:8000/admin`
- کاربران پیش‌فرض:
  - ادمین: `admin` / `admin123`
  - کاربر: `user` / `user123`

**احراز هویت و مسیرها**

- کوکی سشن با HMAC امضا می‌شود و نقش را نگه می‌دارد:
  - تنظیم کوکی: `server/index.js:111–115`
  - بررسی سشن: `server/index.js:95–105`
- APIها:
  - ورود: `server/index.js:127–136`
  - خروج: `server/index.js:138–141`
  - دریافت نقش جاری: `server/index.js:143–146`
  - مدیریت لیست چیلرها (ادمین):
    - لیست: `server/index.js:148–151`
    - افزودن: `server/index.js:153–165`
    - ویرایش: `server/index.js:167–182`
    - حذف: `server/index.js:184–192`
- صفحه‌ها:
  - نگهبانی نقش و هدایت: `server/index.js:194–217`
  - ارائه فایل‌های استاتیک: `server/index.js:219`

**پروکسی دستگاه**

- مسیر پروکسی برای عبور درخواست‌های GET/POST به دستگاه:
  - سیم‌کشی مسیر: `server/index.js:13`
- رفتار پروکسی:
  - دریافت `url` مقصد (فقط `http/https`)
  - فوروار‌دشدن محتوا و `content-type`
  - هدرهای CORS برای دسترسی فرانت‌اند
  - تایم‌اوت و خطای مناسب در صورت عدم پاسخ
- محدودیت دامنه‌های مجاز با متغیر محیطی (در نسخه Next، و مشابه در نسخه Node):
  - `ALLOWED_PROXY_HOSTS=169.254.61.68` (یا فهرست کاماگذاری‌شده)

**پیکربندی پروژه**

- فایل پیکربندی: `assets/data/dashboard.config.json`
  - `deviceUrl`: آدرس نقطه ورود دستگاه (مثلاً `http://169.254.61.68/getvar.csv`)
  - `pollingMs`: بازه زمانی پایش دوره‌ای
  - `units`: آرایه واحدها با نگاشت نام متغیرها
- اشاره دقیق: `assets/data/dashboard.config.json:1–17`

**ارتباط با دستگاه (خواندن/نوشتن)**

- خواندن:
  - اگر `getvar.csv` در دسترس باشد، خواندن مستقیم با `?id=<VarName>` برای متغیرهای خاص انجام می‌شود.
  - در غیر این‌صورت متن کامل `getvar.csv` یا جدول `vars.htm` گرفته و پارس می‌شود:
    - پارس جدول HTML: `dashboard.html:297–324`
    - پارس CSV با تشخیص جداکننده و ستون‌ها: `dashboard.html:326–347` و ادامه
- نوشتن:
  - ارسال به `setvar.csv` با الگوهای مختلف پارامتر:
    - GET: `name=value`, `name=val`, `id=value`, `var=val`
    - POST: بدنه `application/x-www-form-urlencoded` با الگوهای متناظر
  - مسیرهای جایگزین برای `setvar.csv`: ریشه، `pgd/setvar.csv`, `http/setvar.csv` (به‌منظور سازگاری با وب‌کیت‌های مختلف)
  - پس از نوشتن، کش خواندن پاک می‌شود تا مقدار جدید دوباره خوانده شود و تأیید انجام گیرد.
- قفل‌گشایی (درصورت نیاز به مجوز نوشتن):
  - تلاش نوشتن کدهای `1489` و `1234` روی متغیرهای `PwdUser`, `PwdService`, `PwdManuf`
  - پس از موفقیت، مقدار همان متغیر به `0` برگردانده می‌شود.

**صفحه داشبورد**

- کنترل‌ها و نمایش‌ها:
  - روشن/خاموش: روی متغیر دستور و بازخورد (مثلاً `SystemStatus.Ctrl`)
  - ست‌پوینت دما: خواندن از متغیر بازخورد (اغلب با پسوند `_Val`) و نوشتن روی نام با و بدون `_Val` برای سازگاری
  - نمایش دمای فعلی: از متغیر خواندنی (مثلاً `SupplyTemp.ReadVal`)
  - سرعت فن، هشدار فعال، حالت کار: از متغیرهای مرتبط
- حلقه پایش:
  - در بازه `pollingMs` مجموعه‌ای از متغیرها برای هر واحد خوانده می‌شود
  - وضعیت اتصال بر اساس موفق/ناموفق بودن خواندن‌ها تنظیم می‌شود
- تنظیم دستگاه از طریق URL:
  - اضافه کردن `?device=<URL>` به آدرس صفحه (مثال: `http://localhost:8000/?device=http://169.254.61.68/getvar.csv`)
  - حالت دمو: `?demo=1` (به‌روزرسانی‌های محلی بدون نوشتن واقعی)

**نقشه متغیرها (نمونه)**

- نمونه واحد در پیکربندی:
  - `PowerCmd` و `PowerFb`: `SystemStatus.Ctrl`
  - `TempCurrent`: `SupplyTemp.ReadVal`
  - `TempSetpoint`: `CurrRoomTempSetP_Val` (نوشتن روی همین و نسخه بدون `_Val`)
  - `FanSpeedFb`: `MB_Devices.FanElectricalInfo_ZA_1.Modulation`
  - `AlarmActive`: `Al03_PWRP_1.Active`
- اشاره: `assets/data/dashboard.config.json:6–15`

**نکات توسعه و تغییر**

- تغییر دستگاه پیش‌فرض:
  - ویرایش `deviceUrl` در `assets/data/dashboard.config.json`
  - یا استفاده از `?device=` روی URL مرورگر
- افزودن/حذف واحد:
  - ویرایش آرایه `units` در فایل پیکربندی و تنظیم نگاشت متغیرها
- تغییر قواعد احراز هویت/نقش‌ها:
  - تغییر کاربر/رمز پیش‌فرض از متغیرهای محیطی یا کد:
    - `server/index.js:16–20`
- مدیریت چیلرها از API ادمین:
  - POST/PUT/DELETE روی `/api/chillers` (فقط ادمین)

**عیب‌یابی اتصال**

- اگر «Connection failed» می‌بینید:
  - تست دستی پاسخ دستگاه:
    - CSV: `http://localhost:8000/proxy?url=http://169.254.61.68/getvar.csv`
    - جدول: `http://localhost:8000/proxy?url=http://169.254.61.68/vars.htm`
  - مسیرهای جایگزین:
    - `http://localhost:8000/proxy?url=http://169.254.61.68/pgd/getvar.csv`
    - `http://localhost:8000/proxy?url=http://169.254.61.68/http/getvar.csv`
  - بررسی شبکه/فایروال و اینکه سرور پروژه روی پورت 8000 در حال اجراست

**جمع‌بندی جریان کاری**

- فرانت‌اند هر `pollingMs`:
  - یک درخواست به پروکسی برای خواندن داده‌های دستگاه (CSV یا جدول)، پارس و به‌روزرسانی UI
- نوشتن:
  - دکمه «اعمال» ست‌پوینت یا سوییچ روشن/خاموش → فراخوانی پروکسی برای `setvar.csv` با چند الگو و مسیر → پاک‌سازی کش → خواندن‌مجدد → تأیید و نمایش مقدار اعمال‌شده
- احراز هویت:
  - ورود → کوکی امضاشده نقش → دسترسی به `/dashboard` یا `/admin` بر اساس نقش

اگر قصد دارید همین منطق را در چارچوب دیگری (مثلاً Next.js یا یک سرویس بک‌اند دیگر) پیاده کنید، محورهای حیاتی که باید یک هوش‌مصنوعی دیگر بداند عبارت‌اند از: مسیرهای پروکسی و الگوهای نوشتن، نحوه پارس CSV/HTML، ترتیب fallback‌ها، قفل‌گشایی قبل از نوشتن، و نقشه متغیرهای دستگاه در فایل پیکربندی.