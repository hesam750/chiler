عنوان: راهنمای اصلاحات و تکنیک‌های HVAC در داشبورد

خلاصه
- هدف: پایدارکردن نمایش دما و کامفورت، کنترل ایمن روشن/خاموش، تایمرهای قابل‌فهم، و تجربه کاربری بهتر با توست و لودینگ.
- فایل‌های درگیر: dashboard.html، assets/data/dashboard.config.json، server/index.js (افزوده برای ژنراتورها و Modbus)

دما و کامفورت
- نگاشت دمای فعلی: استفاده از Candidateها برای یافتن کلید صحیح دستگاه و مقاوم بودن نسبت به تغییر نام‌ها.
- کلیدهای محتمل: CurrRoomTemp_Val، RoomTempAct_Val، RoomTemp.ReadVal، SupplyTemp.ReadVal، ReturnTemp.ReadVal.
- پیاده‌سازی: tempCurrent به‌صورت Knockout observable با rateLimit برای جلوگیری از رندر زیاد.
- کامفورت: نمایش عدد کنار اسلایدر از فیدبک واقعی (setpointFb) و ثبت پس از اعمال.

پولینگ و نگاشت کانفیگ
- فایل کانفیگ: assets/data/dashboard.config.json شامل vars مثل PowerCmd، PowerFb، TempCurrent، TempSetpoint.
- خواندن فیدبک‌ها در پولینگ با clock داخلی برای تازه‌سازی تایمرهای UI.

کنترل روشن/خاموش
- پیش‌شرط اتصال: قبل از اعمال، اتصال بررسی می‌شود؛ در صورت قطع، پیام خطا و بازگشت به وضعیت قبلی.
- همگام‌سازی: پس از موفقیت، powerFb و powerCmd همسو می‌شوند تا سوییچ وضعیت صحیح را نشان دهد.
- دمو: در حالت DEMO_MODE، اعمال محلی انجام می‌شود ولی نوشتن واقعی انجام نمی‌شود.

توست شناور
- UI پایین صفحه با کلاس‌های toast-* برای error/success/info.
- تابع showToast(msg, type, duration) در <script> عمومی برای نمایش پیام‌ها.
- کاربرد: قطع اتصال هنگام کلیک سوییچ، پیام موفقیت روشن‌شدن بعد از 50 ثانیه.

لودینگ سوییچ
- یک حلقهٔ واحد (progress ring) با عدد وسط.
- مدت: 59 ثانیه؛ پس از پایان، صفحه رفرش می‌شود.
- رفتار: هنگام شروع اعمال، سوییچ مخفی می‌شود؛ پس از اتمام، مجدداً ظاهر می‌شود.
- جلوگیری از لودینگ پس از رفرش: حذف ذخیرهٔ وضعیت ترنزیشن در sessionStorage.

تایمرهای روشن/خاموش
- ذخیره زمان آغاز وضعیت در powerSince و نگه‌داری در localStorage برای پایداری بعد از رفرش.
- فرمت نمایش ساده:
  - زمان: HH/MM/SS (دو رقمی)
  - روز: روزDD (دو رقمی)
- محاسبه بر اساس clock به‌روز شده در سیکل پولینگ.

مدیریت خطاها
- lastError observable برای اعلان‌های صفحه (هدر) و توست شناور.
- Backoff در پولینگ و بررسی isBusy برای جلوگیری از اعمال‌های هم‌زمان.

ایمنی و نقش‌ها
- نوشتن فرمان‌ها فقط در صورت توانایی (canWriteUnit) و عدم Busy.
- برای سرور، endpointهای نوشتن/خواندن ژنراتور فقط برای admin.

افزودنی‌های سرور (ژنراتورها)
- API CRUD برای generators در server/index.js: GET/POST/PUT/DELETE.
- Modbus TCP (سازگار با گیت‌وی‌های RS485->TCP): خواندن Holding و نوشتن Single Register با timeout و مدیریت خطا.
- Endpointها: /api/dse8610/regs، /api/dse8610/reg، /api/dse8610/write.
- نکته: اگر ارتباط RTU باشد، نیاز به درایور سریال یا گیت‌وی؛ نگاشت رجیسترها باید بر اساس GenComm تنظیم شود.

نکات اجرایی
- UI سوییچ: مخفی‌سازی هنگام لودینگ و نمایش حلقهٔ پیشرفت؛ همگام‌سازی فوری با فیدبک پس از موفقیت.
- دما: نرخ‌به‌روز رسانی کنترل شده برای جلوگیری از پرش UI؛ انتخاب مقاوم کلید دما.
- پیام‌ها: خطاهای اتصال و اعلان روشن‌شدن با showToast.

پیشنهاد توسعهٔ بعدی
- افزودن صفحهٔ Admin برای پیکربندی نگاشت رجیسترهای ژنراتور.
- ثبت رخدادها (Audit) برای کلیک‌های Start/Stop و خطاهای ارتباط.

مسیرها و مراجع کد
- dashboard.html: بخش‌های سوییچ، توست، لودینگ، تایمرها.
- assets/data/dashboard.config.json: نگاشت متغیرها.
- server/index.js: API ژنراتورها و Modbus.

تست و اعتبارسنجی
- سناریوها: اتصال قطع/وصل، دمو، اعمال روشن/خاموش، رفرش بعد از پایان لودینگ، نمایش دما و تایمر.
- نتیجه مطلوب: سوییچ و فیدبک همگام، لودینگ فقط یک‌بار، توست و تایمر با فرمت ساده.
