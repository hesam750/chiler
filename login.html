<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>سیستم سرمایشی فناپ</title>
  <link rel="icon" href="./favicon.ico">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a0f1a;
      --bg-secondary: #0e1426;
      --bg-tertiary: #141d2f;
      --fg-primary: #f0f3f8;
      --fg-secondary: #b4bcc8;
      --border-color: #1a2332;
      --accent-primary: #3b82f6;
      --accent-primary-dark: #2563eb;
      --accent-secondary: #10b981;
      --danger: #ef4444;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      width: 100%;
    }

    body {
      font-family: 'Vazirmatn', Tahoma, Arial, sans-serif;
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, var(--bg-primary) 100%);
      color: var(--fg-primary);
      overflow: hidden;
    }

    /* Background fan container */
    .fan-bg {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 0;
      pointer-events: none;
    }

    .fan-bg .vignette {
      position: absolute;
      inset: 0;
      background: radial-gradient(closest-side, rgba(0,0,0,.1) 0%, rgba(0,0,0,.6) 85%);
      mix-blend-mode: multiply;
    }

    .fan-login {
      width: min(55vw, 560px);
      height: min(55vw, 560px);
      border-radius: 50%;
      background: radial-gradient(60% 60% at 50% 50%, #0c1220 0%, #08101a 60%, #050a14 100%);
      border: 1px solid rgba(59, 130, 246, 0.1);
      box-shadow: inset 0 0 20px rgba(0,0,0,.8), 0 8px 32px rgba(0,0,0,.5), 0 0 60px rgba(59, 130, 246, 0.05);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: auto;
    }

    .fan-login svg {
      width: calc(100% - 16px);
      height: calc(100% - 16px);
      filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.2));
    }

    .fan-login .blade {
      transform-origin: 50% 50%;
      animation: spin 8s linear infinite;
      will-change: transform, filter;
    }

    .fan-login::before {
      content: "";
      position: absolute;
      inset: 10px;
      border-radius: 50%;
      pointer-events: none;
      opacity: .25;
      background: repeating-radial-gradient(circle at 50% 50%, rgba(255,255,255,.08) 0 1px, transparent 1px 8px);
    }

    .fan-login::after {
      content: "";
      position: absolute;
      inset: 6px;
      border-radius: 50%;
      pointer-events: none;
      opacity: .2;
      background: repeating-conic-gradient(from 0deg, rgba(59, 130, 246, .1) 0 8deg, transparent 8deg 22deg);
      -webkit-mask-image: radial-gradient(circle at 50% 50%, transparent 0 34%, black 34% 100%);
      mask-image: radial-gradient(circle at 50% 50%, transparent 0 34%, black 34% 100%);
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    @media (prefers-reduced-motion: reduce) {
      .fan-login .blade {
        animation: none !important;
      }
    }

    /* Main wrapper */
    .wrap {
      position: relative;
      z-index: 2;
      min-height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    /* Card styling - Enhanced card with better shadow and backdrop effect */
    .card {
      width: 100%;
      max-width: 420px;
      background: rgba(14, 20, 38, 0.75);
      border: 1px solid rgba(59, 130, 246, 0.15);
      border-radius: 20px;
      padding: 40px 32px;
      -webkit-backdrop-filter: blur(12px) saturate(1.2);
      backdrop-filter: blur(12px) saturate(1.2);
      box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.05);
      animation: slideUp 0.6s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Improved typography */
    .brand {
      font-weight: 700;
      font-size: 24px;
      margin-bottom: 12px;
      letter-spacing: -0.5px;
      color: var(--fg-primary);
    }

    .subtitle {
      color: var(--fg-secondary);
      font-size: 14px;
      line-height: 1.5;
      margin-bottom: 28px;
      font-weight: 400;
    }

    /* Form groups */
    .form-group {
      margin-bottom: 20px;
    }

    .form-group:last-of-type {
      margin-bottom: 24px;
    }

    /* Enhanced form label styling */
    .form-label {
      font-size: 13px;
      font-weight: 500;
      color: var(--fg-secondary);
      margin-bottom: 8px;
      display: block;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Improved input styling with better focus states */
    .form-input {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      background: rgba(10, 15, 26, 0.5);
      color: var(--fg-primary);
      font-family: 'Vazirmatn', Tahoma, Arial, sans-serif;
      font-size: 15px;
      transition: all 0.3s ease;
    }

    .form-input::placeholder {
      color: rgba(180, 188, 200, 0.6);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent-primary);
      background: rgba(10, 15, 26, 0.8);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-input:hover:not(:focus) {
      border-color: rgba(59, 130, 246, 0.3);
    }

    /* Error message */
    .error {
      color: var(--danger);
      font-size: 13px;
      margin-top: 8px;
      display: none;
      animation: shake 0.4s ease-in-out;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-4px); }
      75% { transform: translateX(4px); }
    }

    /* Actions */
    .actions {
      display: block;
      margin-top: 28px;
    }

    /* Enhanced button styling */
    .btn {
      border-radius: 12px;
      border: none;
      font-family: 'Vazirmatn', Tahoma, Arial, sans-serif;
      font-size: 15px;
      font-weight: 600;
      padding: 12px 24px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .actions .btn {
      width: 100%;
      padding: 14px 24px;
      font-size: 16px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-primary-dark) 100%);
      color: white;
      box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3);
    }

    .btn-primary:hover:not(:disabled) {
      background: linear-gradient(135deg, var(--accent-primary-dark) 0%, #1d4ed8 100%);
      box-shadow: 0 12px 32px rgba(59, 130, 246, 0.4);
      transform: translateY(-2px);
    }

    .btn-primary:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Brand logo */
    .brand-logo {
      position: fixed;
      left: 20px;
      bottom: 20px;
      z-index: 3;
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 14px;
      padding: 10px 14px;
      -webkit-backdrop-filter: blur(8px);
      backdrop-filter: blur(8px);
      text-decoration: none;
      transition: all 0.3s ease;
    }

    .brand-logo:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(59, 130, 246, 0.4);
      box-shadow: 0 8px 24px rgba(59, 130, 246, 0.1);
    }

    .brand-logo img {
      height: 28px;
      filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.35));
    }

    .brand-logo .txt {
      color: var(--fg-primary);
      font-weight: 600;
      font-size: 13px;
      letter-spacing: 0.3px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .wrap {
        padding: 16px;
      }

      .card {
        max-width: 100%;
        padding: 32px 24px;
      }

      .fan-login {
        width: min(65vw, 420px);
        height: min(65vw, 420px);
      }

      .brand {
        font-size: 22px;
      }
    }

    @media (max-width: 480px) {
      .card {
        padding: 28px 20px;
      }

      .fan-login {
        width: min(75vw, 300px);
        height: min(75vw, 300px);
        box-shadow: inset 0 0 15px rgba(0,0,0,.7), 0 4px 12px rgba(0,0,0,.4), 0 0 40px rgba(59, 130, 246, 0.03);
      }

      .brand {
        font-size: 20px;
      }

      .brand-logo {
        left: 14px;
        bottom: 14px;
        padding: 8px 10px;
      }

      .brand-logo img {
        height: 24px;
      }

      .brand-logo .txt {
        font-size: 11px;
      }
    }
  </style>
</head>
<body>
  <!-- Background fan -->
  <div class="fan-bg" aria-hidden="true">
    <div class="fan fan-login">
      <svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <linearGradient id="bladeMetal" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#cfd5db" />
            <stop offset="40%" stop-color="#9aa2aa" />
            <stop offset="60%" stop-color="#858c94" />
            <stop offset="100%" stop-color="#d6dbe0" />
          </linearGradient>
          <linearGradient id="edgeHighlight" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#ffffff" stop-opacity="0.25" />
            <stop offset="30%" stop-color="#ffffff" stop-opacity="0.05" />
            <stop offset="100%" stop-color="#000000" stop-opacity="0.08" />
          </linearGradient>
          <radialGradient id="hubMetal" cx="50%" cy="50%" r="50%">
            <stop offset="0%" stop-color="#e7eaee" />
            <stop offset="65%" stop-color="#c2c7ce" />
            <stop offset="100%" stop-color="#9ba2aa" />
          </radialGradient>
          <linearGradient id="shroudGrad" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stop-color="#757c84" />
            <stop offset="100%" stop-color="#444a50" />
          </linearGradient>
          <clipPath id="fanClip">
            <circle cx="60" cy="60" r="52" />
          </clipPath>
        </defs>

        <circle cx="60" cy="60" r="56" fill="url(#shroudGrad)" stroke="#2f3337" stroke-width="4" />
        <circle cx="60" cy="60" r="50" fill="none" stroke="#1f2327" stroke-width="1" opacity="0.6" />

        <g class="blade" clip-path="url(#fanClip)">
          <g transform="translate(60,60)">
            <g transform="scale(0.80)">
              <g id="blade6" fill="url(#bladeMetal)">
                <path d="M 2 -18 C 8 -30, 22 -40, 34 -42 C 45 -44, 50 -42, 52 -38 C 54 -33, 49 -27, 42 -24 C 33 -20, 22 -15, 14 -9 C 6 -3, 0 4, -2 10 C -4 15, -6 18, -10 18 C -14 18, -16 14, -16 10 C -16 2, -10 -8, 2 -18 Z" />
              </g>
              <use href="#blade6" transform="rotate(0)" />
              <use href="#blade6" transform="rotate(60)" />
              <use href="#blade6" transform="rotate(120)" />
              <use href="#blade6" transform="rotate(180)" />
              <use href="#blade6" transform="rotate(240)" />
              <use href="#blade6" transform="rotate(300)" />
            </g>
          </g>
        </g>

        <circle cx="60" cy="60" r="12" fill="url(#hubMetal)" stroke="#3b4147" stroke-width="0.9" />
        <circle cx="60" cy="60" r="4" fill="#343a40" />
      </svg>
    </div>
    <div class="vignette"></div>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="brand">سیستم سرمایشی</div>
      <!-- <p class="subtitle">برای دسترسی به سامانه لطفاً وارد شوید.</p> -->

      <div class="form-group">
        <label class="form-label" for="login-username">نام کاربری</label>
        <input id="login-username" type="text" class="form-input" placeholder="نام کاربری سازمانی" autocomplete="username" aria-label="نام کاربری" />
      </div>

      <div class="form-group">
        <label class="form-label" for="login-password">رمز عبور</label>
        <input id="login-password" type="password" class="form-input" placeholder="رمز عبور خود را وارد کنید" autocomplete="current-password" aria-label="رمز عبور" />
      </div>

      <div class="error" id="login-error">ورود نامعتبر</div>

      <div class="actions">
        <button id="login-submit" class="btn btn-primary">ورود</button>
      </div>
    </div>
  </div>

  <!-- Fanap logo -->
  <a class="brand-logo" href="https://fanap.ir" target="_blank" rel="noopener" aria-label="Fanap Tech">
    <img src="/fanap.png" alt="Fanap Tech" />
    <span class="txt">Fanap Tech</span>
  </a>

  <script>
    (function(){
      var API_BASE = '';
      function loadCfg(){
        if(window.__cfg) return Promise.resolve(window.__cfg);
        return fetch('/assets/data/dashboard.config.json')
          .then(function(r){ return r.json(); })
          .then(function(j){
            window.__cfg = j || {};
            API_BASE = (j && j.apiBaseUrl) || '';
            return window.__cfg;
          })
          .catch(function(){
            window.__cfg = {};
            API_BASE = '';
            return window.__cfg;
          });
      }

      function api(p){ return (API_BASE || '') + p; }

      function getNext(){
        try {
          var params = new URLSearchParams(window.location.search || '');
          var n = params.get('next');
          return n && n.trim() ? n : null;
        } catch(_) { return null; }
      }

      function redirectByRole(role){
        var next = getNext();
        if(next){ window.location.replace(next); return; }
        if(role === 'admin') window.location.replace('/admin');
        else window.location.replace('/dashboard');
      }

      function checkAuth(){
        return loadCfg()
          .then(function(){ return fetch(api('/api/me')); })
          .then(function(r){ return r.json(); })
          .then(function(info){
            var role = (info && info.role) || 'guest';
            return { authenticated: role !== 'guest', user: { role: role } };
          })
          .catch(function(){ return { authenticated:false }; });
      }

      function submitLogin(){
        var btn = document.getElementById('login-submit');
        var u = document.getElementById('login-username');
        var p = document.getElementById('login-password');
        var err = document.getElementById('login-error');
        var username = (u && u.value || '').trim();
        var password = (p && p.value || '').trim();

        if(!username || !password){
          if(err){
            err.textContent='نام کاربری و رمز عبور لازم است';
            err.style.display='block';
          }
          return;
        }

        if(err) err.style.display='none';
        if(btn) {
          btn.disabled = true;
          btn.textContent = 'درحال ورود...';
        }

        loadCfg()
          .then(function(){
            return fetch(api('/api/login'), {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username: username, password: password })
            });
          })
          .then(function(r){
            if(!r.ok) throw new Error('HTTP '+r.status);
            return r.json();
          })
          .then(function(info){
            var role = (info && info.role) || 'user';
            redirectByRole(role);
          })
          .catch(function(){
            if(err){
              err.textContent='ورود نامعتبر';
              err.style.display='block';
            }
          })
          .finally(function(){
            if(btn){
              btn.disabled=false;
              btn.textContent='ورود';
            }
          });
      }

      document.addEventListener('DOMContentLoaded', function(){
        checkAuth().then(function(info){
          if(info && info.authenticated){
            var role = info.user && info.user.role || 'user';
            redirectByRole(role);
          }
        });

        var btn = document.getElementById('login-submit');
        if(btn) btn.addEventListener('click', submitLogin);

        document.addEventListener('keydown', function(e){
          if(e.key === 'Enter'){ submitLogin(); }
        });
      });
    })();
  </script>
</body>
</html>
