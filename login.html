<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>سیستم سرمایشی فناپ</title>
  <link rel="icon" href="./favicon.ico">
  <link rel="stylesheet" href="/css/bootstrap.min.css" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#0b1220; --card:#0f172a; --fg:#e5e7eb; --muted:#94a3b8; --border:#1f2937; --primary:#2563eb; --primary-700:#1d4ed8; --danger:#ef4444; }
    html, body { height: 100%; }
    body { font-family: 'Vazirmatn', Tahoma, Arial, sans-serif; background: radial-gradient(1200px 800px at 50% 50%, #0b1220 0%, #050a14 100%); color: var(--fg); }
    .wrap { position:relative; z-index: 2; min-height:100%; display:flex; align-items:center; justify-content:center; padding: 24px; }
    /* Glassy login card for production */
    .card { width: 420px; max-width: 95vw; background: rgba(15,23,42,.72); border: 1px solid rgba(255,255,255,.08); border-radius: 16px; box-shadow: 0 30px 120px rgba(0,0,0,.45); padding: 20px; -webkit-backdrop-filter: blur(8px) saturate(1.05); backdrop-filter: blur(8px) saturate(1.05); }
    .brand { font-weight:700; font-size:18px; margin-bottom: 6px; }
    .muted { color: var(--muted); font-size: 13px; }
    .form-label { font-size:13px; color:var(--muted); margin-bottom:6px; }
    .form-input { width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#0b1220; color:#e5e7eb; }
    .actions { display:flex; gap:8px; justify-content:flex-end; margin-top:14px; }
    .btn { border-radius:8px; }
    .btn-primary { background: var(--primary); border-color: var(--primary-700); }
    .error { color: var(--danger); font-size: 13px; margin-top: 8px; display:none; }

    /* Rotating fan background (exactly like chiller cards) */
    .fan-bg { position: fixed; inset: 0; display:flex; align-items:center; justify-content:center; z-index:0; pointer-events:none; }
    .fan-bg .vignette { position:absolute; inset:0; background: radial-gradient(closest-side, rgba(0,0,0,.0) 0%, rgba(0,0,0,.55) 85%); mix-blend-mode:multiply; }
    .fan-login { width: min(62vw, 640px); height: min(62vw, 640px); border-radius:50%; background: radial-gradient(60% 60% at 50% 50%, #0c121a, #09111a 60%, #071018 100%); border:1px solid #233042; box-shadow: inset 0 0 12px rgba(0,0,0,.6), 0 8px 18px rgba(0,0,0,.4); display:flex; align-items:center; justify-content:center; margin:auto; }
    .fan-login svg { width: calc(100% - 16px); height: calc(100% - 16px); }
    .fan-login .blade { transform-origin:50% 50%; animation: spin 6s linear infinite; will-change: transform, filter; }
    .fan-login.running svg { filter: drop-shadow(0 0 12px rgba(46,204,113,.45)); }
    .fan-login::before { content:""; position:absolute; inset: 10px; border-radius:50%; pointer-events:none; opacity:.35; background: repeating-radial-gradient(circle at 50% 50%, rgba(255,255,255,.09) 0 1px, transparent 1px 8px); }
    .fan-login::after { content:""; position:absolute; inset: 6px; border-radius:50%; pointer-events:none; opacity:.35; background: repeating-conic-gradient(from 0deg, rgba(255,255,255,.08) 0 8deg, transparent 8deg 22deg); -webkit-mask-image: radial-gradient(circle at 50% 50%, transparent 0 34%, black 34% 100%); mask-image: radial-gradient(circle at 50% 50%, transparent 0 34%, black 34% 100%); }
    @keyframes spin { from { transform: rotate(0deg);} to { transform: rotate(360deg);} }
    @media (prefers-reduced-motion: reduce){ .fan-login .blade { animation:none !important; } }

    /* Responsive adjustments for mobile */
    @media (max-width: 640px){
      .wrap { padding: 16px; }
      .card { width: 94vw; padding: 16px; }
      .fan-login { width: min(80vw, 380px); height: min(80vw, 380px); box-shadow: inset 0 0 10px rgba(0,0,0,.55), 0 6px 14px rgba(0,0,0,.35); }
      .brand-logo { bottom: 10px; left: 10px; padding: 6px 8px; }
      .brand-logo img { height: 22px; }
      .brand-logo .txt { font-size: 11px; }
    }
    @media (max-width: 400px){
      .fan-login { width: min(88vw, 320px); height: min(88vw, 320px); }
      .card { width: 96vw; }
    }

    /* Fanap logo */
    .brand-logo { position: fixed; left: 18px; bottom: 18px; z-index: 3; display:flex; align-items:center; gap:8px; background: rgba(255,255,255,.05); border: 1px solid rgba(255,255,255,.12); border-radius: 12px; padding: 8px 10px; backdrop-filter: blur(4px); }
    .brand-logo img { height: 26px; filter: drop-shadow(0 2px 8px rgba(0,0,0,.35)); }
    .brand-logo .txt { color:#e5e7eb; font-weight:600; font-size:12px; }
  </style>
</head>
<body>
  <!-- Background fan (borrowed from ChillerCardComponent) -->
  <div class="fan-bg" aria-hidden="true">
    <div class="fan fan-login running">
      <svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <!-- Metal finish for blades -->
          <linearGradient id="bladeMetal" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#cfd5db" />
            <stop offset="40%" stop-color="#9aa2aa" />
            <stop offset="60%" stop-color="#858c94" />
            <stop offset="100%" stop-color="#d6dbe0" />
          </linearGradient>
          <!-- Edge highlight to suggest thickness -->
          <linearGradient id="edgeHighlight" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#ffffff" stop-opacity="0.25" />
            <stop offset="30%" stop-color="#ffffff" stop-opacity="0.05" />
            <stop offset="100%" stop-color="#000000" stop-opacity="0.08" />
          </linearGradient>
          <!-- Hub metal -->
          <radialGradient id="hubMetal" cx="50%" cy="50%" r="50%">
            <stop offset="0%" stop-color="#e7eaee" />
            <stop offset="65%" stop-color="#c2c7ce" />
            <stop offset="100%" stop-color="#9ba2aa" />
          </radialGradient>
          <!-- Shroud gradient -->
          <linearGradient id="shroudGrad" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stop-color="#757c84" />
            <stop offset="100%" stop-color="#444a50" />
          </linearGradient>
        </defs>

        <!-- Shroud / Housing ring with inner lip -->
        <circle cx="60" cy="60" r="56" fill="url(#shroudGrad)" stroke="#2f3337" stroke-width="4" />
        <circle cx="60" cy="60" r="50" fill="none" stroke="#1f2327" stroke-width="1" opacity="0.6" />

        <!-- Blades group with animation -->
        <g class="blade">
          <g transform="translate(60,60)">
            <g id="blade6" fill="url(#bladeMetal)">
              <path d="M 2 -18 C 8 -30, 22 -40, 34 -42 C 45 -44, 50 -42, 52 -38 C 54 -33, 49 -27, 42 -24 C 33 -20, 22 -15, 14 -9 C 6 -3, 0 4, -2 10 C -4 15, -6 18, -10 18 C -14 18, -16 14, -16 10 C -16 2, -10 -8, 2 -18 Z" stroke="#2d3237" stroke-width="0.6" />
              <path d="M 4 -16 C 12 -26, 24 -36, 36 -38" fill="none" stroke="url(#edgeHighlight)" stroke-width="1" opacity="0.55" />
            </g>
            <use href="#blade6" transform="rotate(0)" />
            <use href="#blade6" transform="rotate(60)" />
            <use href="#blade6" transform="rotate(120)" />
            <use href="#blade6" transform="rotate(180)" />
            <use href="#blade6" transform="rotate(240)" />
            <use href="#blade6" transform="rotate(300)" />
          </g>
        </g>

        <!-- Hub and bolts -->
        <circle cx="60" cy="60" r="11" fill="url(#hubMetal)" stroke="#3b4147" stroke-width="0.9" />
        <circle cx="60" cy="60" r="4" fill="#343a40" />
        <g fill="#666b72" stroke="#2d3237" stroke-width="0.5">
          <circle cx="60" cy="12" r="2" />
          <circle cx="60" cy="12" r="2" transform="rotate(60 60 60)" />
          <circle cx="60" cy="12" r="2" transform="rotate(120 60 60)" />
          <circle cx="60" cy="12" r="2" transform="rotate(180 60 60)" />
          <circle cx="60" cy="12" r="2" transform="rotate(240 60 60)" />
          <circle cx="60" cy="12" r="2" transform="rotate(300 60 60)" />
        </g>
      </svg>
    </div>
    <div class="vignette"></div>
  </div>
  <div class="wrap">
    <div class="card">
      <div class="brand">سیستم سرمایشی</div>
      <!-- <p class="muted">برای دسترسی به سامانه لطفاً وارد شوید.</p> -->
      <div class="form-group" style="margin-top:10px;">
        <div class="form-label">نام کاربری</div>
        <input id="login-username" type="text" class="form-input" placeholder="نام کاربری سازمانی" autocomplete="username" aria-label="نام کاربری" />
      </div>
      <div class="form-group" style="margin-top:8px;">
        <div class="form-label">رمز عبور</div>
        <input id="login-password" type="password" class="form-input" placeholder="رمز عبور" autocomplete="current-password" aria-label="رمز عبور" />
      </div>
      <div class="error" id="login-error">ورود نامعتبر</div>
      <div class="actions">
        <button id="login-submit" class="btn btn-primary">ورود</button>
      </div>
      <!-- <div class="muted" style="margin-top:12px;">در صورت مشکل در ورود، با سرپرست سیستم تماس بگیرید.</div>
    </div> -->
  </div>

  <!-- Fanap logo corner -->
  <a class="brand-logo" href="https://fanap.ir" target="_blank" rel="noopener">
    <img src="/fanap.png" alt="Fanap Tech" />
    <span class="txt">Fanap Tech</span>
  </a>

  <script>
    (function(){
      var API_BASE = '';
      function loadCfg(){ if(window.__cfg) return Promise.resolve(window.__cfg); return fetch('/assets/data/dashboard.config.json').then(function(r){ return r.json(); }).then(function(j){ window.__cfg = j || {}; API_BASE = (j && j.apiBaseUrl) || ''; return window.__cfg; }).catch(function(){ window.__cfg = {}; API_BASE=''; return window.__cfg; }); }
      function api(p){ return (API_BASE || '') + p; }
      function getNext(){
        try {
          var params = new URLSearchParams(window.location.search || '');
          var n = params.get('next');
          return n && n.trim() ? n : null;
        } catch(_) { return null; }
      }
      function redirectByRole(role){
        var next = getNext();
        if(next){ window.location.replace(next); return; }
        if(role === 'admin') window.location.replace('/admin');
        else window.location.replace('/dashboard');
      }
      function checkAuth(){
        return loadCfg().then(function(){ return fetch(api('/api/me')); })
          .then(function(r){ return r.json(); })
          .then(function(info){ var role = (info && info.role) || 'guest'; return { authenticated: role !== 'guest', user: { role: role } }; })
          .catch(function(){ return { authenticated:false }; });
      }
      function submitLogin(){
        var btn = document.getElementById('login-submit');
        var u = document.getElementById('login-username');
        var p = document.getElementById('login-password');
        var err = document.getElementById('login-error');
        var username = (u && u.value || '').trim();
        var password = (p && p.value || '').trim();
        if(!username || !password){ if(err){ err.textContent='نام کاربری و رمز عبور لازم است'; err.style.display='block'; } return; }
        if(err) err.style.display='none';
        if(btn) { btn.disabled = true; btn.textContent = 'در حال ورود...'; }
        loadCfg().then(function(){ return fetch(api('/api/login'), { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ username: username, password: password }) }); })
          .then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
          .then(function(info){ var role = (info && info.role) || 'user'; redirectByRole(role); })
          .catch(function(){ if(err){ err.textContent='ورود نامعتبر'; err.style.display='block'; } })
          .finally(function(){ if(btn){ btn.disabled=false; btn.textContent='ورود'; } });
      }

      document.addEventListener('DOMContentLoaded', function(){
        // اگر قبلاً وارد شده، مستقیم هدایت شو (با احترام به next)
        checkAuth().then(function(info){ if(info && info.authenticated){ var role = info.user && info.user.role || 'user'; redirectByRole(role); } });
        var btn = document.getElementById('login-submit');
        if(btn) btn.addEventListener('click', submitLogin);
        document.addEventListener('keydown', function(e){ if(e.key === 'Enter'){ submitLogin(); } });
      });
    })();
  </script>
</body>
</html>