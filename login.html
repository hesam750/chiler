<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ورود | Chiller Dashboard</title>
  <link rel="icon" type="image/png" sizes="192x192" href="fanap.png">
  <link rel="stylesheet" href="css/bootstrap.min.css" />
  <link rel="stylesheet" href="css/theme.css" />
  <link rel="stylesheet" href="css/rtl.css" />
  <style>
    body { background: var(--bg); color: var(--text); font-family: 'IRANSansX','Vazirmatn',Tahoma,Arial,sans-serif; }
    .wrap { min-height: 100vh; display:flex; align-items:center; justify-content:center; padding:16px; }
    .card { width: 100%; max-width: 420px; background: var(--card-bg); border:1px solid var(--card-border); border-radius:16px; box-shadow: 0 12px 32px rgba(0,0,0,.35); }
    .card-header { padding:16px; border-bottom:1px solid var(--card-border); display:flex; align-items:center; justify-content:space-between; }
    .brand { display:flex; align-items:center; gap:10px; }
    .brand img { height:28px; }
    .card-body { padding:16px; display:grid; gap:12px; }
    .btn-primary { background: var(--accent); border-color: var(--accent); color: var(--accent-contrast); }
    .muted { color: var(--muted); font-size:12px; }
    @media (max-width: 480px) { .card { border-radius:12px; } }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="card-header">
        <div class="brand">
          <img src="fanap.png" alt="Fanap" />
          <strong>ورود</strong>
        </div>
      </div>
      <div class="card-body">
        <div class="muted">لطفاً وارد شوید</div>
        <input id="u" class="form-control" type="text" placeholder="نام کاربری">
        <input id="p" class="form-control" type="password" placeholder="رمز عبور">
        <button id="go" class="btn btn-primary" type="button">ورود</button>
        <div id="err" class="muted" style="color:#e74c3c; min-height:20px;"></div>
      </div>
    </div>
  </div>
  <script>
    (function(){
      fetch('/api/me').then(function(r){ return r.json(); }).then(function(j){
        var role = String((j&&j.role)||'guest');
        if(role==='admin') { location.replace('/admin'); return; }
        if(role==='user') { location.replace('/dashboard'); return; }
      }).catch(function(){});
      var btn = document.getElementById('go');
      var u = document.getElementById('u');
      var p = document.getElementById('p');
      var err = document.getElementById('err');
      function login(){
        err.textContent = '';
        var body = JSON.stringify({ username: String(u.value||''), password: String(p.value||'') });
        fetch('/api/login', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: body })
          .then(function(r){ if(!r.ok) throw new Error('x'); return r.json(); })
          .then(function(j){ var role = String((j&&j.role)||'user'); if(role==='admin') location.replace('/admin'); else location.replace('/dashboard'); })
          .catch(function(){ err.textContent = 'ورود ناموفق'; });
      }
      if(btn) btn.addEventListener('click', login);
      [u,p].forEach(function(el){ if(el){ el.addEventListener('keydown', function(e){ if(e.key==='Enter') login(); }); }});
    })();
  </script>
</body>
</html>